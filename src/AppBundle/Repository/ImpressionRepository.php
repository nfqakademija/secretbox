<?php

namespace AppBundle\Repository;

use AppBundle\Entity\Impression;
use AppBundle\Entity\User;
use Doctrine\ORM\EntityRepository;

/**
 * ImpressionRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ImpressionRepository extends EntityRepository
{
    /**
     * @param Impression $impression
     */
    public function saveImpression(Impression $impression)
    {
        $this->_em->persist($impression);
        $this->_em->flush();
    }

    /**
     * @param $userId
     *
     * @return Impression[]
     */
    public function getImpressions($userId)
    {
        $impressions = $this->findBy(['userId' => $userId], ['created' => 'DESC']);

        return $impressions;
    }

    /**
     * @param integer $limit
     *
     * @return Impression[]
     */
    public function getLastImpressions($limit)
    {
        $queryBuilder = $this->_em->createQueryBuilder();
        $queryBuilder
            ->select('i.impression', 'i.createdAt', 'u.firstName', 'u.lastName', 'u.pictureUrl')
            ->from(Impression::class, 'i')
            ->innerJoin(
                User::class,
                'u',
                \Doctrine\ORM\Query\Expr\Join::WITH,
                'i.user = u.id'
            )
            ->where('i.approved = 1')
            ->orderBy('i.createdAt', 'DESC')
            ->setMaxResults($limit);
        $impressions = $queryBuilder->getQuery()->execute();

        return $impressions;
    }
}
